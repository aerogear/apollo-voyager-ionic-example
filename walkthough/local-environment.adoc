// update the component versions for each release
:rhmi-version: 1

// URLs
:openshift-console-url: {openshift-host}/console
:sso-realm-url: {user-sso-url}/auth/admin/solution-patterns/console/index.html
:data-sync-documentation-url: https://access.redhat.com/documentation/en-us/red_hat_managed_integration/{rhmi-version}/html-single/developing_a_data_sync_app/index

//attributes
:title: Creating your Data Sync Application using Node.JS, MongoDB and GraphQL
:integreatly-name: Managed Integration
:data-sync-name: Data Sync
:data-sync-starter: Data Sync Starter
:customer-sso-name: Customer Application SSO
:realm-name: solution-patterns
:realm-display-name: Solution Patterns
:shared-realm-username: developer
:realm-password: password
:standard-fail-text: Verify that you followed all the steps. If you continue to have issues, contact your administrator.

//id syntax is used here for the custom IDs because that is how the Solution Explorer sorts these within groups
[id='5-adding-data-sync-graphql']
= {title}

// word count that fits best is 15-22, with 20 really being the sweet spot. Character count for that space would be 100-125
Learn how to build applications that can perform realtime data synchronization with DataSync and GraphQL.

This solution pattern will show you how to:

* Build DataSync server based on your business model
* Protect the application's frontend and backend using {customer-sso-name}.
* Explore all the capabilities provided by {data-sync-name}.

The following diagram shows the architecture of the {data-sync-starter}:

image::images/arch.png[architecture, role="integr8ly-img-responsive"]

[type=walkthroughResource, serviceName=openshift]
.Red Hat OpenShift
****
* link:{openshift-console-url}[Console, window="_blank"]
* link:https://docs.openshift.com/dedicated/4/welcome/index.html/[OpenShift Documentation, window="_blank"]
* link:https://blog.openshift.com/[OpenShift Blog, window="_blank"]
****

[type=walkthroughResource]
.Data Sync
****
* link:{data-sync-documentation-url}[Getting Started with {data-sync-name}, window="_blank"]
****

:sectnums:

[time=15]
== Creating your {data-sync-name} project from DataSync Starter template

{data-sync-name} allows you to focus on your business model by giving you ability
to generate fully functional GraphQL based API and Node.js Server and Client Side components.

DataSync will allow your application to recieve live updates thanks to GraphQL subscriptions and
operate independently of network connection. Developers can create GrapQL types as model 
and generate underlying backend that will work out of the box with the RHMI services like SSO or AMQ Online

[time=30]
=== Setting your DataSync project using DataSync Starter

. Install yarn `npm install -g yarn`
. Clone git repository: `git clone https://github.com/aerogear/datasync-starter`
. Go to cloned repository: `cd datasync-starter`
. Install dependencies `yarn install`

=== Creating your DataSync model

DataSync model offers capability to generate underlying GraphQL API and database infrastructure.
Starter template by default will use MongoDB database as datasource for storing all your data.

. In your project go to `./model/task.graphql` file. 
This file contains GraphQL compatible schema 
. Please add `@datasync` annotation to the model right bellow `@model` annotation
Those annotations can be used to control various behaviour of datasync.
`@model` will create standard data access methods, while `@datasync` is going to provide data synchronization capabilities.
. Models can be changed by adding new types or fields. Please add new field by creating new line inside `Task` type
and `address: String`
. Your task model should look as follows
----
""" 
@model
@datasync
"""
type Task {
  id: ID!
  title: String!
  description: String!
  status: TaskStatus
  address: String
}
----

=== Generating your DataSync Node.JS server and React Client

DataSync provides code generation capabilities that will transform your model to the fully 
functional client and server application.
DataSync-starter template contains folowing folders:

- `./server` folder that contains Node.js server implementation
- `./client` folder that contains React based application
- `.graphqlrc.yml`

. Review `.graphqlrc.yml` file. This file contains configuration for your data access methods
and available plugins that will be used for source code generation
. Please make sure that all fields in `crud` section are enabled 
. Execute graphback cli command to generate source code:
`yarn graphback generate`
. Review `./server/src/schema/schema.qraphql`. 
This file contains your model along with access methods that were enabled in configuration.
. Review generated resolver files in `./server/src/resolvers/resolvers.ts`
This file contains methods used to fetch data. Each individual method will use 
preconfigured MongoDataProvider. Developers can point resolvers to any datasource.
Currently Postres and MongoDB are supported.
. Review your `./client/src/graphql/` folder containing client side queries for your data.

=== Running DataSync client and server applications

. Open new terminal window
. Execute `docker-compose up -d` to start MongoDB container
. Execute `yarn prepare:client` to build client side React application and include it in server runtime
. Execute `yarn start:server`. Terminal should print similar output:

----
    ***********************************************************
    ðŸŽ® Ionic PWA application available at http://localhost:4000
    ðŸš€ GraphQL Playground is available at http://localhost:4000/graphql
    ***********************************************************
----

. Open `PWA application URL` printed in terminal

[type=verification]
****
. Check if website was loaded properly
. Select + icon to create new item
. On new screen put `name` and `description`
The client should create a task and it should be 
. New task should appear on the list
----
****

[type=verificationFail]
****
Check the logs of the console
Verify that you followed each step in the procedure above.  
If you are still having issues, contact your administrator.
****

=== Interacting with embeeded GraphQL Playground

GraphQL Playground acts as GraphQL API client that allows 
you to interact with your types without implementing new views in your application.
In this section we going to focus on learning who to use playground.

. Open new terminal window
. Execute `yarn start:server`
. Open GraphQL Playground URL printed in console.
You can use the GraphQL playground to interact with the server API as described in the next step.
. Go to the Playground interface and replace the text in the left pane of the screen with the following query and mutation:

----
query listTasks {
  allTasks {
    title,
    description,
    address,
    id
  }
}

mutation createTask {
  createTask(title: "complete the walkthrough", description: "complete the GraphQL walkthrough", address: "NA") {
    title,
    description,
    version,
    address,
    id
  }
}
----

[type=verification]
****
. Click the Run icon in the middle of the playground screen.
. Choose createTask from the menu.
The system should create a task.
. Choose listTasks from the Run menu.
. Check that the following is displayed in the right hand panel:
. You should also see field that we have added in previous steps
+
----
{
    "data": {
        "allTasks": [
            {
                "title": "complete the walkthrough",
                "description": "complete the GraphQL walkthrough",
                "id": "1",
                "address": "NA"
            }
        ]
    }
}
----
****

[type=verificationFail]
****
Check the logs of the `ionic-showcase-server` pod.

It should include the string `+connected to messaging service+`.
Verify that you followed each step in the procedure above.  If you are still having issues, contact your administrator.
****

[time=5]
== Running and verifying your DataSync server

The {data-sync-starter} provides:
  
  - offline operation support
  - out of the box live updates
  - conflict resolution

In this guide we are going to explore capabilities of the datasync by using 
sample application available as part of {data-sync-starter}.
Application by default is designed to work with `Task` model but it can be extended 
to use very Type automatically exposed by underlying server GraphQL API.

. Go back to application opened in previous step.
. Create a task by clicking on the plus icon in the bottom right-hand side of the screen.
. Add a title and description, of your choosing, to the task and click *Create*.
. Copy the current url without the '/tasks' endpoint and paste in a different tab, browser or mobile browser.
. Change the status of the task by clicking/unclicking the text box beside the task.


[type=verification]
****
Verify that the status of the task is synced across all tabs in real-time.
****

[type=verificationFail]
****
Verify that you followed each step in the procedure above.  If you are still having issues, contact your administrator.
****

[time=10]
== Exploring data sync features using the Data Sync showcase application

To explore data sync features, you should run multiple instances of the {data-sync-starter} using different browsers.
For example, use the browser on your mobile device as well as using the browser on your laptop.

To get the url of your app:

. Go to link:{route-ionic-showcase-server-host}[Data Sync].

image::images/showcase.png[showcase, role="integr8ly-img-responsive"]

=== Exploring real-time sync

. On your laptop:
.. Create a new task using *+* icon.
.. Enter some task text  and click *Create*.

. On your mobile device:
.. Check that the same task appears in the *Manage Tasks* page.
.. Make some changes to the task.

. On your laptop:
.. Check that the task changes are appear.


[type=verification]
****
Did the tasks appear as expected?
****

[type=verificationFail]
****
Verify that you followed each step in the procedure above.  If you are still having issues, contact your administrator.
****


=== Exploring offline support

. On your mobile device:
.. Log into the {data-sync-starter}.
.. Activate airplane mode or disable network connectivity.
.. Create a new task.
The task should be created and the *Offline Changes* button in the footer should contain one change.
.. Make a few more changes by either editing existing tasks, or creating new ones.
.. Review all the changes by clicking the *Offline Changes* button.

. On your laptop:
.. Log into the {data-sync-starter}.
You do not see any of the changes from the mobile device.

. On your mobile device:
.. Restore connectivity or deactivate airplane modes.
.. Watch the status of the tasks change.

. On your laptop:
.. Check that all the tasks are synced.


[type=verification]
****
Did the tasks appear as expected?
****

[type=verificationFail]
****
Verify that you followed each step in the procedure above.  If you are still having issues, contact your administrator.
****

=== Resolving conflicts

. On your mobile device:
.. Log into the {data-sync-starter}.
.. Create a task `todo A`.
.. Activate airplane mode or disable network connectivity.
.. Edit the task description to add the text `edited on mobile`.

. On your laptop:
.. Log into the {data-sync-starter}.
.. Simulate offline mode. For example, in Chrome, press F12 to open *Developer Tools* and select *offline* in  the *Network* tab.
.. Edit the `todo A` task, change the text to `todo B`.

. Bring both of your devices back online, the tasks should sync without a conflict.

. On your mobile device:
.. Activate airplane mode or disable network connectivity.
.. Edit task `todo B` change the description to:
+
----
Conflicting description from mobile
----

. On your laptop:
.. Simulate offline mode. For example, in Chrome, press F12 to open *Developer Tools* and select *offline* in  the *Network* tab.
.. Edit task `todo B` change the description to:
+
----
Conflicting description from laptop
----

. Bring both of your devices back online, a popup window should appear warning you about conflicts.

[type=verification]
****
Did the tasks sync as expected?
****

[type=verificationFail]
****
Verify that you followed each step in the procedure above.  If you are still having issues, contact your administrator.
****


[time=15]
== Add authentication and authorization to the Data Sync application using Red Hat SSO

In this task, we will configure both the frontend and the backend of the 
{data-sync-starter} with the {customer-sso-name}.

DataSync starter has authentication and autorization enabled out of the box.
Developers need to configure server and client application to use their keycloak instance
and add required authorization rules to their model.


== Add authorization to GraphQL route

. 


@hasRole(role: "admin")

=== Configuring Authentication using Keycloak (SSO)

DataSync starter provides out of the box 

Follow these steps to create a client.

. Go to the link:{sso-realm-url}[{realm-display-name}, window="_blank"] realm, which is running on your {customer-sso-name} service.
.. If prompted, enter the username `{shared-realm-username}` and password `{realm-password}`.
. You will see the *{realm-name}* realm if the login is successful.
. Select *Clients* from the vertical navigation menu on the left side of the screen.
. Click the *Create* button on the top right of the Clients screen.
. On the *Add Client* screen:
.. In the *Client ID* field, enter
+
[subs="attributes+"]
----
{user-username}-frontend
----
.. Verify the *Client Protocol* is set to *openid-connect*.
.. Click *Save*.
. You will see the *Settings* screen for the *{client-name}* client if the save is successful.
. on the *Settings* page:
.. Change `Valid Redirect URIs` to `{route-ionic-showcase-server-host}*`
.. Change `Web Origins` to `*`
.. Click on the *Save* button
.. Click on the *Installation* tab, and select `Keycloak OIDC JSON` format. Copy the content displayed or use the `Download` button to save the configuration file.

. Update the configuration of the frontend app to secure it:
.. Go to the link:{openshift-host}/console/project/{walkthrough-namespace}/browse/config-maps[OpenShift Config Maps] page.
.. Select the config map that is called `webapp-config`, and edit it by selecting `Edit` under the `Actions` button.
.. Add a new `auth` section to the config map by pasting the content that was copied in the previous step.
.. Rename the `auth-server-url` attribute to `url` and the `resource` attribute to `clientId`.
.. Save it

[type=verification]
****
Does the content of the config map look as follows:
[subs="attributes"]
----
   window.showcaseConfig = {
     "backend": {
       "serverUrl": "/graphql",
       "wsServerUrl": ((window.location.protocol === "https:") ? "wss://" : "ws://") + window.location.hostname + "/graphql"
     },
     "auth": {
       "realm": "walkthroughs",
    	 "url": " {user-sso-url}/auth",
   	   "ssl-required": "none",
   	   "clientId": "{user-username}-frontend",
   	   "public-client": true,
   	   "confidential-port": 0
     }
   };
----
****

[type=verificationFail]
****
Verify that you followed each step in the procedure above.  If you are still having issues, contact your administrator.
****
[time=10]

=== Configuring and protecting the Back-end App

Follow these steps to create a client.

. Go to the link:{sso-realm-url}[{realm-display-name}, window="_blank"] realm, which is running on your {customer-sso-name} service.
.. If prompted, enter the username `{shared-realm-username}` and password `{realm-password}`.
. You will see the *{realm-name}* realm if the login is successful.
. Select *Clients* from the vertical navigation menu on the left side of the screen.
. Click the *Create* button on the top right of the Clients screen.
. On the *Add Client* screen:
.. In the *Client ID* field, enter
+
[subs="attributes+"]
----
{user-username}-server
----
.. Verify the *Client Protocol* is set to *openid-connect*.
.. Click *Save*.
. You will see the *Settings* screen for the *{user-username}-server* client if the save is successful.
. Change the *Access Type* to *bearer-only*.
.. Click *Save*.
.. Click on the *Installation* tab, and select `Keycloak OIDC JSON` format. Use the `Download` button to save the `keycloak.json` configuration file.

. Create users for testing:

.. Select *Users* on the left menu, and click on *View all users*.
.. Click on *Add user* to create a new user. Pick a username you like for the *Username* field and click *Save*.
.. Select the *Credentials* tab and set a password for this user. Set *Temporary* option to *OFF*.
.. Click *Reset Password*

. Update the backend to use the downloaded configuration file:
.. Go to the link:{openshift-host}/console/project/{walkthrough-namespace}/browse/config-maps[OpenShift Config Maps] page.
.. Click *Create Config Map*.
.. When prompted for *Name*, enter:
+
----
showcase-server-idm-config
----
.. When prompted for *Key*, enter:
+
----
keycloak.json
----
.. For *Value*, click *Browse* and load the json file that you downloaded previously.
.. Click *Create*. The config map object is created.
.. Choose *Deployments* from the *Applications* menu.
.. Select the deployment config for `ionic-showcase-server`.
.. Click on the *Configuration* tab, and scroll to the *Volumes* section.
.. Click on the *Add Config Files* option at the bottom of the section.
.. Choose the `showcase-server-idm-config` config map as the *Source*.
.. Set the value for *Mount Path* to:
+
----
/tmp/keycloak
----

.. Click *Add* to trigger a new deployment.
.. Click the *Environment* tab and click *Add Value*.
.. Set Name to:
+
----
KEYCLOAK_CONFIG
----

.. Set Value to:
+
----
/tmp/keycloak/keycloak.json
----

.. Click *Save*


[type=verification]
****
Has the deployment completed?
Do you see SSO login screen when you go to the link:{route-ionic-showcase-server-host}[{data-sync-starter}, window="_blank"]?
****

[type=verificationFail]
****
Verify that you followed each step in the procedure above.  If you are still having issues, contact your administrator.
****

